{% extends "layout.html" %}
{% block title %}Gestion des Tarifs{% endblock %}
{% block content %}
<style>
  :root{
    --ink:#0f172a;         /* gris bleu profond */
    --ink-2:#475569;       /* secondaire */
    --bg:#f6f7fb;          /* fond page */
    --card:#ffffff;        /* cartes */
    --pri:#0ea5e9;         /* primaire (bleu) */
    --pri-600:#0284c7;
    --ok:#16a34a;
    --ko:#ef4444;
    --ring:0 0 0 3px rgba(14,165,233,.15);
    --shadow:0 12px 24px rgba(2,8,23,.08);
  }

  /* Layout dashboard */
  .dashboard-container{ min-height: calc(100vh - 80px); background:var(--bg); }
  .sidebar{
    width:260px; background:#0b1220; color:#e5e7eb; padding:24px; position:sticky; top:0; height:100%;
    box-shadow: inset -1px 0 0 rgba(255,255,255,.05);
  }
  .sidebar h2{ font-size:1.1rem; letter-spacing:.02em; color:#cbd5e1; margin-bottom:18px}
  .menu-item{
    padding:10px 12px; border-radius:10px; cursor:pointer; margin-bottom:6px;
    display:flex; align-items:center; gap:10px; transition: all .18s ease;
  }
  .menu-item:hover{ background:rgba(255,255,255,.06); transform: translateX(2px); }
  .menu-item.active{ background:linear-gradient(90deg, rgba(14,165,233,.25), rgba(14,165,233,.05)); color:#fff; }

  /* Main section */
  .main-content{ max-width:1400px; margin-inline:auto; }
  .page-head{
    display:flex; justify-content:space-between; align-items:center; gap:16px;
    padding:8px 0 16px;
  }
  .page-head h3{ margin:0; color:var(--ink) }

  /* Toolbar */
  .toolbar{
    display:flex; gap:10px; flex-wrap:wrap;
  }
  .toolbar .form-control{ min-width:260px; }
  .btn-primary{
    background:var(--pri); border-color:var(--pri);
  }
  .btn-primary:hover{ background:var(--pri-600); border-color:var(--pri-600); }

  /* Card wrapper */
  .card-wrap{
    background:var(--card); border:1px solid #eef0f5; border-radius:16px; box-shadow: var(--shadow);
  }
  .card-head{
    padding:14px 16px; border-bottom:1px solid #eef0f5; display:flex; align-items:center; gap:12px; justify-content:space-between;
  }
  .table-responsive{ border-radius: 0 0 16px 16px; }
  table.table{ margin:0; }
  thead.table-light th{
    background:#f8fafc !important; color:#334155; font-weight:600; font-size:.92rem;
    position:sticky; top:0; z-index:1;
  }
  td, th{ vertical-align: middle !important; }
  .vehicle-img{ border-radius:10px; box-shadow:0 6px 16px rgba(2,8,23,.06) }

  /* Badges */
  .badge-soft{
    background:#ecfeff; color:#0369a1; border:1px solid #bae6fd;
  }
  .badge-ok{
    background:#ecfdf5; color:#166534; border:1px solid #bbf7d0;
  }
  .badge-ko{
    background:#fef2f2; color:#991b1b; border:1px solid #fecaca;
  }

  /* Modal header */
  .modal-header{
    background:linear-gradient(90deg, var(--pri), var(--pri-600)); box-shadow: var(--ring);
  }

  /* Small screens */
  @media (max-width: 992px){
    .sidebar{ display:none; }
    .dashboard-container{ padding-top:8px; }
  }
</style>

<style>
  /* ——— Styles locaux à la page Tarifs (aucun impact ailleurs) ——— */
  .tarifs-wrap { width:100%; padding:24px; }
  .tarifs-header {
    display:flex; align-items:center; justify-content:space-between;
    padding:16px 20px; margin-bottom:20px;
    background:#fff; border-radius:14px; box-shadow:0 10px 24px rgba(16,24,40,.06);
  }
  .tarifs-header h2 { margin:0; font-weight:700; }
  .tarifs-header .muted { color:#6c7a86; font-size:.95rem; }

  .card-soft {
    background:#fff; border-radius:14px; padding:18px;
    box-shadow:0 10px 24px rgba(16,24,40,.06);
  }
  .card-soft h5 { font-weight:700; margin-bottom:14px; }
  .help { font-size:.85rem; color:#6c7a86; }

  .grid-forms { display:grid; gap:20px; grid-template-columns: 1fr 1fr; }
  @media (max-width: 992px){ .grid-forms { grid-template-columns:1fr; } }

  .btn-primary { background:#20c997; border-color:#20c997; }
  .btn-primary:hover { background:#17b88a; border-color:#17b88a; }

  .table-shell { margin-top:22px; }
  .table-shell .card-soft { padding:0; overflow:hidden; }
  .table thead th { background:#f7faf9; color:#33434f; font-weight:700; }
  .table td, .table th { vertical-align:middle; }
  .badge.rounded-pill { padding:.45rem .7rem; font-weight:600; }
</style>

<div class="dashboard-container d-flex">
  <!-- Sidebar identique -->
  <div class="sidebar">
    <h2>Tableau de bord</h2>
    <div class="menu-item" onclick="window.location.href='{{ url_for('main.reservations_admin') }}'">Réservations</div>
    <div class="menu-item" onclick="window.location.href='{{ url_for('main.admin_dashboard') }}'">Véhicules</div>
    <div class="menu-item active" onclick="window.location.href='{{ url_for('main.tarifs_admin') }}'">Tarifs</div>
  </div>

  <!-- Contenu principal -->
  <div class="tarifs-wrap">

    <!-- En-tête -->
    <div class="tarifs-header">
      <div>
        <h2 class="mb-1">Gestion des Tarifs</h2>
        <div class="muted">Forfaits & règles de tarification — DS Travel</div>
      </div>
      <a href="{{ url_for('main.home') }}" class="btn btn-outline-secondary">
        <i class="bi bi-house-door me-1"></i> Accueil site
      </a>
    </div>

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <!-- Formulaires -->
    <div class="grid-forms">
      <!-- === Formulaire tarif forfaitaire (inchangé côté logique) === -->
      <div class="card-soft">
        <h5><i class="bi bi-cash-coin me-2 text-success"></i>Ajouter un tarif forfaitaire</h5>

        {% if form_forfait.errors %}
          <div class="alert alert-danger mb-3">
            <strong>Erreurs dans le formulaire forfait :</strong>
            <ul class="mb-0">
              {% for field, errors in form_forfait.errors.items() %}
                <li><strong>{{ field }}</strong> : {{ errors|join(', ') }}</li>
              {% endfor %}
            </ul>
          </div>
        {% endif %}

        <form method="POST">
          {{ form_forfait.hidden_tag() }}
          <input type="hidden" name="form_name" value="forfait">

          <div class="row g-3">
            <div class="col-md-6">
              {{ form_forfait.depart.label(class="form-label fw-semibold") }}
              {{ form_forfait.depart(class="form-control", id="depart", placeholder="Ex. Dakar, AIBD…") }}
              <div class="help mt-1">Point de départ (Google Autocomplete activé)</div>
            </div>
            <div class="col-md-6">
              {{ form_forfait.arrivee.label(class="form-label fw-semibold") }}
              {{ form_forfait.arrivee(class="form-control", id="arrivee", placeholder="Ex. Thiès…") }}
              <div class="help mt-1">Point d’arrivée</div>
            </div>

            <div class="col-md-6">
              {{ form_forfait.prix_cfa.label(class="form-label fw-semibold") }}
              {{ form_forfait.prix_cfa(class="form-control", placeholder="Ex. 25000") }}
              <div class="help mt-1">Prix forfaitaire TTC (FCFA)</div>
            </div>
            <div class="col-md-6">
              {{ form_forfait.distance_km.label(class="form-label fw-semibold") }}
              {{ form_forfait.distance_km(class="form-control", placeholder="Ex. 60") }}
              <div class="help mt-1">Distance de référence (km)</div>
            </div>

            <div class="col-md-6 d-flex align-items-center gap-2">
              <div class="form-check">
                {{ form_forfait.bidirectionnel(class="form-check-input", id="bidirectionnel") }}
                {{ form_forfait.bidirectionnel.label(class="form-check-label fw-semibold") }}
              </div>
              <div class="help">Le tarif vaut aussi dans le sens inverse</div>
            </div>

            <div class="col-md-6 d-flex align-items-center gap-2">
              <div class="form-check">
                {{ form_forfait.actif(class="form-check-input", id="actif") }}
                {{ form_forfait.actif.label(class="form-check-label fw-semibold") }}
              </div>
              <div class="help">Affichable côté site / utilisable</div>
            </div>

            <div class="col-12">
              {{ form_forfait.submit(class="btn btn-primary px-4") }}
            </div>
          </div>
        </form>
      </div>

      {# Si tu as un 2e formulaire (règles kilométriques), tu peux le placer ici dans une autre .card-soft #}
      {# <div class="card-soft">…</div> #}
    </div>

    <!-- Tableau des forfaits -->
    <div class="table-shell">
      <div class="card-soft">
        <div class="p-3 border-bottom d-flex align-items-center justify-content-between">
          <h5 class="mb-0"><i class="bi bi-list-ul me-2 text-success"></i>Forfaits existants</h5>
          <span class="help">{{ forfaits|length }} élément(s)</span>
        </div>

        <div class="p-3">
          <div class="table-responsive">
            <table class="table table-hover align-middle mb-0">
              <thead>
                <tr>
                  <th>Trajet</th>
                  <th>Prix</th>
                  <th>Statut</th>
                  <th class="text-end">Actions</th>
                </tr>
              </thead>
              <tbody>
              {% if forfaits %}
                {% for t in forfaits %}
                  <tr>
                    <td class="fw-semibold">
                      {{ t.depart }} → {{ t.arrivee }}
                      {% if t.bidirectionnel %}<span class="ms-1 text-muted">(↔)</span>{% endif %}
                      {% if t.distance_km %}<div class="help">~ {{ t.distance_km }} km</div>{% endif %}
                    </td>
                    <td class="fw-bold">{{ "{:,.0f}".format(t.prix_cfa).replace(",", " ") }} F</td>
                    <td>
                      {% if t.actif %}
                        <span class="badge rounded-pill bg-success">Actif</span>
                      {% else %}
                        <span class="badge rounded-pill bg-secondary">Inactif</span>
                      {% endif %}
                    </td>
                    <td class="text-end">
                      <a class="btn btn-sm btn-outline-secondary"
                         href="{{ url_for('main.toggle_tarif_forfait', id=t.id) }}">
                        Activer / Désactiver
                      </a>
                      <a class="btn btn-sm btn-outline-danger"
                         href="{{ url_for('main.delete_tarif_forfait', id=t.id) }}"
                         onclick="return confirm('Supprimer ce forfait ?')">
                        Supprimer
                      </a>
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                  <tr>
                    <td colspan="4" class="text-center text-muted py-4">
                      Aucun forfait pour le moment.
                    </td>
                  </tr>
              {% endif %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

  </div><!-- /tarifs-wrap -->
</div><!-- /dashboard-container -->

{# === Google Maps Places Autocomplete (inchangé) === #}
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBy8naZgWRwxtGy7lztqvaEhb0L6ODbJMs&libraries=places"></script>
<script>
function initAutocomplete() {
  const departInput  = document.getElementById('depart');
  const arriveeInput = document.getElementById('arrivee');

  if (departInput) {
    new google.maps.places.Autocomplete(departInput, {
      types: ['geocode'],
      componentRestrictions: { country: 'sn' }
    });
  }
  if (arriveeInput) {
    new google.maps.places.Autocomplete(arriveeInput, {
      types: ['geocode'],
      componentRestrictions: { country: 'sn' }
    });
  }
}
document.addEventListener('DOMContentLoaded', initAutocomplete);
</script>

{% endblock %}
